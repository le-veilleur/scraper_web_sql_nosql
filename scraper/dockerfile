# Étape 1 : Construire le binaire
FROM golang:1.22-alpine AS builder

# Arguments de build pour le versioning
ARG VERSION=production
ARG GIT_COMMIT=unknown
ARG BUILD_TIME=unknown

# Installer les outils nécessaires
RUN apk add --no-cache git ca-certificates tzdata

WORKDIR /app

# Copier les fichiers de dépendances depuis la racine du projet
COPY go.mod go.sum ./
RUN go mod download

# Copier le code source du scraper
COPY scraper/ ./scraper/

# Construire le binaire avec versioning
RUN CGO_ENABLED=0 GOOS=linux go build \
    -ldflags="-s -w -X main.version=${VERSION} -X main.gitCommit=${GIT_COMMIT} -X main.buildTime=${BUILD_TIME}" \
    -o scraper-binary ./scraper/scraper.go

# Étape 2 : Image finale minimale
FROM scratch

# Redéclarer les arguments pour cette étape
ARG VERSION=production
ARG GIT_COMMIT=unknown
ARG BUILD_TIME=unknown

# Copier les certificats CA pour HTTPS
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

# Copier les données de timezone
COPY --from=builder /usr/share/zoneinfo /usr/share/zoneinfo

WORKDIR /app

# Copier le binaire
COPY --from=builder /app/scraper-binary /app/scraper

# Labels pour traçabilité
LABEL version="${VERSION}" \
      git.commit="${GIT_COMMIT}" \
      build.time="${BUILD_TIME}" \
      maintainer="Maxime tezsur@gmail.com>" \
      description="Go API MongoDB Scrapper - Scraper Service" \
      org.opencontainers.image.source="https://github.com/maxime-louis14/go_api_mongo_scrapper"

# Variables d'environnement par défaut
ENV SCRAPER_MAX_WORKERS=20 \
    SCRAPER_TIMEOUT=30s \
    SCRAPER_BASE_URL=https://www.allrecipes.com \
    SCRAPER_MAX_PAGES=5 \
    SCRAPER_MAX_RECIPES_PER_PAGE=20 \
    LOG_LEVEL=info

# Démarrer l'application
ENTRYPOINT ["/app/scraper"]