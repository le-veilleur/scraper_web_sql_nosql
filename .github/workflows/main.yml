name: Déploiement - Main

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Déploiement sur VPS
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PI_SSH_KEY }}

      - name: Deploy to server
        env:
          PI_HOST: ${{ secrets.PI_HOST }}
          PI_USER: ${{ secrets.PI_USER }}
          PI_PORT: ${{ secrets.PI_PORT }}
        run: |
          ssh -o StrictHostKeyChecking=no -p ${PI_PORT} ${PI_USER}@${PI_HOST} << 'EOF'
            # Aller dans le dossier du projet
            cd ~/GitHub/scraper_web_sql_nosql
            
            # Sauvegarder les modifications locales (stash) pour éviter les conflits
            git stash || true
            
            # Récupérer les dernières modifications
            git pull origin main
            
            # Arrêter les services (utiliser docker compose v2)
            docker compose down || true
            
            # Reconstruire toutes les images avec --no-cache pour forcer la reconstruction
            docker compose build --no-cache
            
            # Redémarrer tous les services
            docker compose up -d
            
            # Nettoyer les anciennes images
            docker image prune -f
            
            # Afficher le statut des services
            docker compose ps
          EOF

